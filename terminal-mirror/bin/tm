#!/usr/bin/env bash
# tm â€” Universal terminal wrapper + mirror CLI
#
# Usage:
#   tm <command> [args...]    Wrap a command in a PTY with mirror socket
#   tm start-server [opts]    Start multi-session mirror web server
#   tm list                   List active tm-wrapper sessions

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PLUGIN_DIR="$(dirname "$SCRIPT_DIR")"
WRAPPER_JS="$PLUGIN_DIR/scripts/tm-wrapper.js"
MIRROR_JS="$PLUGIN_DIR/scripts/mirror-server.js"
LIST_JS="$PLUGIN_DIR/scripts/tm-list.js"

# Auto-install dependencies if needed
ensure_deps() {
  if [ ! -d "$PLUGIN_DIR/node_modules" ]; then
    echo "Installing dependencies..." >&2
    (cd "$PLUGIN_DIR" && npm install) >&2
  fi
}

# Subcommand routing
case "${1:-}" in
  start-server)
    shift
    ensure_deps
    exec node "$MIRROR_JS" "$@"
    ;;
  list)
    shift
    ensure_deps
    exec node "$LIST_JS" "$@"
    ;;
  -h|--help|"")
    echo "Usage:"
    echo "  tm <command> [args...]    Wrap a command in a PTY with mirror socket"
    echo "  tm start-server [opts]    Start multi-session mirror web server"
    echo "  tm list                   List active tm-wrapper sessions"
    echo ""
    echo "Examples:"
    echo "  tm claude --model sonnet  Wrap Claude with terminal mirror support"
    echo "  tm bash                   Wrap bash"
    echo "  tm vim file.txt           Wrap vim"
    echo "  tm start-server           Start mirror server (auto-discovers all sessions)"
    echo "  tm start-server --remote  Start mirror server accessible on LAN"
    exit 0
    ;;
  *)
    ensure_deps
    exec node "$WRAPPER_JS" "$@"
    ;;
esac
